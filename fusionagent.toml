# ==============================================================================
# FusionAgent - Unified Configuration Example
# ==============================================================================
# This file demonstrates ALL available configuration options for FusionAgent.
# Copy this to fusionagent.toml and adjust values for your setup.
# ==============================================================================

# ------------------------------------------------------------------------------
# [orchestrator.server] - MCP server configuration
# ------------------------------------------------------------------------------
# Configure the orchestrator MCP server that handles inter-agent communication.
# Default: host = "127.0.0.1", port = 3000, transport = "HTTP"
# Override with environment variables: SERVER_HOST, SERVER_PORT, SERVER_TRANSPORT
# ------------------------------------------------------------------------------

[orchestrator.server]
host = "127.0.0.1"
port = 3000
transport = "HTTP"  # HTTP or GRPC

# ==============================================================================
# SUMMARY OF ALL SERVERS IN FUSIONAGENT
# ==============================================================================
# This configuration defines two independent servers:
# 1. [orchestrator.server]  - MCP server (port 3000)  - Inter-agent communication
# 2. [web]                  - Dashboard UI (port 8081) - Web dashboard interface
# ==============================================================================

# ------------------------------------------------------------------------------
# [web] - Web dashboard server configuration
# ------------------------------------------------------------------------------
# Configure the embedded web dashboard server that provides a UI for the orchestrator.
# This server hosts the web interface for monitoring agents and tasks.
# Default: host = "0.0.0.0", port = 8081
# Override with environment variables: WEB_HOST, WEB_PORT, WEB_CORS_ENABLED, etc.
# ------------------------------------------------------------------------------

[web]
host = "0.0.0.0"
port = 8081
staticPath = "static"

[web.cors]
enabled = true
allowedOrigins = ["http://localhost:8081", "http://127.0.0.1:8081"]

# ------------------------------------------------------------------------------
# [agents] - Agent definitions
# ------------------------------------------------------------------------------
# Configure the AI agents that will be used by the orchestrator.
# Each agent needs a unique ID (the part after agents.) and configuration.
#
# Available agent types:
# - CLAUDE_CODE: Anthropic Claude via Claude Code CLI
# - CODEX_CLI: OpenAI Codex via Codex CLI
# - Q_CLI: Amazon Q via Q CLI
# - GEMINI: Google Gemini
# - GPT: OpenAI GPT models (requires model parameter)
# - MISTRAL: Mistral AI models (requires model parameter)
# - LLAMA: Meta Llama models (requires model parameter)
# ------------------------------------------------------------------------------

[agents.claude-code]
type = "CLAUDE_CODE"
name = "Claude"
# Optional parameters:
# model = "claude-3-5-sonnet-20241022"
# temperature = 0.7
# maxTokens = 4096

[agents.codex-cli]
type = "CODEX_CLI"
name = "Codex"
# Optional parameters:
# model = "gpt-4"
# temperature = 0.7

[agents.q-cli]
type = "Q_CLI"
name = "Q"
# Optional parameters:
# model = "q-developer"

[agents.gemini]
type = "GEMINI"
name = "Gemini"
# Optional parameters:
# model = "gemini-1.5-pro"
# apiKeyRef = "${GOOGLE_API_KEY}"

# Example custom GPT agent
# [agents.gpt-custom]
# type = "GPT"
# name = "Custom GPT"
# model = "gpt-4-turbo"
# apiKeyRef = "${OPENAI_API_KEY}"
# organization = "${OPENAI_ORG}"
# temperature = 0.7
# maxTokens = 8192

# Example Mistral agent
# [agents.mistral]
# type = "MISTRAL"
# name = "Mistral Large"
# model = "mistral-large-latest"
# apiKeyRef = "${MISTRAL_API_KEY}"
# temperature = 0.7

# Example Llama agent
# [agents.llama]
# type = "LLAMA"
# name = "Llama 3"
# model = "llama-3-70b"
# apiKeyRef = "${LLAMA_API_KEY}"

# ------------------------------------------------------------------------------
# [context] - Context system configuration
# ------------------------------------------------------------------------------

[context]
# Enable or disable the entire context subsystem
enabled = true

# ------------------------------------------------------------------------------
# [context.engine] - Context system engine configuration
# Configuration for the file indexing and semantic search engine.
# This is internal configuration and does not control any external server port.
# The web dashboard is controlled by [web] section instead.
# Default: timeout_ms = 10000, retry_attempts = 3
# Override with environment variables: CONTEXT_ENGINE_TIMEOUT_MS, CONTEXT_ENGINE_RETRY_ATTEMPTS
# ------------------------------------------------------------------------------

[context.engine]
timeout_ms = 10000
retry_attempts = 3

# ------------------------------------------------------------------------------
# [context.storage] - Database and persistence settings
# ------------------------------------------------------------------------------

[context.storage]
db_path = "./context.duckdb"

# ==============================================================================
# [context.watcher] - File system watcher configuration
# ==============================================================================
# The watcher monitors file system changes and decides which files to index.
# ignore_patterns filter OUT entire directory trees at the WATCHER PHASE,
# preventing the watcher from monitoring unnecessary directories.
#
# ignore_patterns:
#   - Applied when files are FIRST DISCOVERED by the watcher
#   - Uses REGEX matching (flexible but complex)
#   - Can include files from .gitignore, .contextignore, .dockerignore
#   - Purpose: Prevent watcher overhead for large auto-generated directories
#
# Examples of what to put in ignore_patterns:
#   - Large build directories: build/, dist/, target/, out/
#   - Version control: .git/, .svn/, .hg/
#   - Package managers: node_modules/, venv/, .venv/
#   - IDE configuration: .idea/, .vscode/, .gradle/
#   - Auto-generated build metadata: .kotlin/, .angular/, .nuxt/
# ==============================================================================

[context.watcher]
enabled = true
debounce_ms = 500
# Monitor these top-level workspaces. Each entry can be absolute or relative.
watch_paths = [
    "/Users/sergeyrudenko/projects/codex_to_claude",
    "/Users/sergeyrudenko/projects/of_mcp"
]

# IGNORE_PATTERNS: Exclude entire directories at watcher discovery phase
# These are checked FIRST, preventing watcher from monitoring these directories
# Regex patterns are supported (glob-like syntax works: *, **, path/)
ignore_patterns = [
    ".kotlin/",           # Kotlin build metadata - auto-generated
    ".gradle/",           # Gradle build metadata
    "build/",             # Build outputs
    "dist/",              # Distribution/compiled outputs
    "target/",            # Maven build outputs
    ".git/",              # Version control - skip watching
    "node_modules/",      # Node packages
    ".venv/",             # Python virtual environments
    "venv/",              # Python virtual environments
]
use_gitignore = true          # Also respects .gitignore automatically
use_contextignore = false     # Set true to also respect .contextignore

# ==============================================================================
# [context.indexing] - File indexing and filtering settings
# ==============================================================================
# IMPORTANT: Key difference from ignore_patterns:
#
# ignore_patterns (watcher phase):
#   - Blocks entire directories EARLY at watcher discovery
#   - Prevents watcher from monitoring (efficiency)
#   - Uses regex matching
#   - Example: ".kotlin/" blocks entire .kotlin/metadata directory
#
# skip_patterns (indexing phase):
#   - Applied AFTER extension filtering to indexed files
#   - Fine-grained control at file level
#   - Uses glob patterns (more intuitive: *, **, file names)
#   - Example: "*.min.js" blocks minified files that passed extension filter
#
# Processing order:
#   1. ignore_patterns filters at watcher discovery (prevents monitoring)
#   2. allowed_extensions filters by file type (.ts, .py, .md, etc.)
#   3. skip_patterns filters specific files (*.test.ts, *.min.js, etc.)
#   4. Binary detection (ignores .pdf, .jpg, .png, .exe, etc.)
#   5. Size limits (skips files > maxFileSizeMb)
#
# WHY BOTH?
#   - ignore_patterns: Watcher efficiency (don't monitor huge directories)
#   - skip_patterns: Indexing precision (don't index build artifacts/tests)
# ==============================================================================

[context.indexing]
allowed_extensions = [
    ".kt", ".kts", ".java", ".py", ".ts", ".tsx", ".js", ".jsx",
    ".json", ".md", ".yaml", ".yml", ".csv", ".txt", ".doc", ".docx", ".pdf", ".v", ".css", ".toml", ".sql"
]

# SKIP_PATTERNS: Exclude specific files AFTER extension filtering
# These patterns use GLOB syntax (more intuitive than regex)
# Applied during the INDEXING PHASE to files that passed extension filter
#
# Two types of patterns:
#   Simple patterns (no "/" or "**"):
#     - "*.min.js" matches only the filename
#     - Useful for: minified files, test files, generated files
#
#   Absolute patterns (contain "/" or "**"):
#     - "**/dist/**" matches anywhere in path
#     - Useful for: directory-level filtering after watcher (double-check)
#
# Examples of what to put in skip_patterns:
#   - "*.min.js"          # Minified JavaScript (already watched out, but double-check)
#   - "*.min.css"         # Minified CSS
#   - "*.test.ts"         # Test files (TypeScript)
#   - "*.spec.js"         # Test files (Jest/Jasmine)
#   - "**/coverage/**"     # Code coverage reports
#   - "**/dist/**"        # Built/compiled output (redundant with ignore_patterns but safe)
#   - "*test*"            # Any file with "test" in name
#   - "*.generated.kt"    # Auto-generated code
skip_patterns = [
    # Test and spec files
    "*.test.ts",          # TypeScript test files
    "*.test.js",          # JavaScript test files
    "*.spec.ts",          # TypeScript spec files
    "*.spec.js",          # JavaScript spec files

    # Minified assets
    "*.min.js",           # Minified JavaScript
    "*.min.css",          # Minified CSS

    # Generated/compiled outputs
    "*.generated.kt",     # Auto-generated Kotlin
    "*.generated.java",   # Auto-generated Java

    # Build artifacts (redundant with ignore_patterns, but safer as double-check)
    "**/dist/**",         # Distribution/compiled outputs
    "**/build/**",        # Build artifacts
    "**/node_modules/**", # Node packages
]

# Maximum file size (MB) for indexing files
# Files larger than this size are skipped during indexing
max_file_size_mb = 200
warn_file_size_mb = 10
size_exceptions = []
follow_symlinks = false
max_symlink_depth = 3
binary_detection = "ALL"  # Options: EXTENSION, MIME, CONTENT, ALL
binary_threshold = 30

# ------------------------------------------------------------------------------
# [context.embedding] - Vector embedding configuration
# ------------------------------------------------------------------------------

[context.embedding]
model = "sentence-transformers/all-MiniLM-L6-v2"
# Path to the ONNX model file. If not specified, uses default bundled all-MiniLM-L6-v2 model or ONNX_MODEL_PATH env var
# model_path = "/Users/sergeyrudenko/projects/codex_to_claude/model.onnx"
dimension = 384
batch_size = 128
normalize = true
cache_enabled = true

#bigger external model
#model = "sentence-transformers/baai-bge-base-en-v1.5-onnx/"
#model_path = "/Users/sergeyrudenko/projects/codex_to_claude/model.onnx"
#dimension = 768  # Adjust to match your model's output dimension
#batch_size = 128
#normalize = true
#cache_enabled = true

# ------------------------------------------------------------------------------
# [context.chunking] - Text chunking strategies per language
# ------------------------------------------------------------------------------

[context.chunking.markdown]
max_tokens = 400
split_by_headings = true
preserve_code_blocks = true

[context.chunking.python]
max_tokens = 600
split_by_function = true
overlap_percent = 15
preserve_docstrings = true

[context.chunking.kotlin]
max_tokens = 600
split_by_class = true
split_by_function = true
preserve_kdoc = true

[context.chunking.typescript]
max_tokens = 600
split_by_export = true
preserve_jsdoc = true

# ------------------------------------------------------------------------------
# [context.query] - Query and retrieval settings
# ------------------------------------------------------------------------------

[context.query]
default_k = 7  # Default number of results for query_context (cleaner, focused results)
mmr_lambda = 0.5  # 0.0 = max diversity, 1.0 = max relevance
min_score_threshold = 0.35  # Lower threshold to include document-language results (CVs, docs, etc)
rerank_enabled = true

# ------------------------------------------------------------------------------
# [context.budget] - Token budget management
# ------------------------------------------------------------------------------

[context.budget]
default_max_tokens = 1500
reserve_for_prompt = 500
warn_threshold_percent = 80

# ------------------------------------------------------------------------------
# [context.providers] - Context provider configurations
# ------------------------------------------------------------------------------

[context.providers.full_text]
enabled = true
weight = 0.1

[context.providers.semantic]
enabled = true
weight = 0.6

[context.providers.symbol]
enabled = true
weight = 0.3
index_ast = true

[context.providers.git_history]
enabled = true
weight = 0.2
max_commits = 100

[context.providers.hybrid]
enabled = true
weight = 0.5
combines = ["semantic", "symbol", "git_history", "full_text"]  # Include all providers for comprehensive search
fusion_strategy = "rrf"  # Options: rrf, weighted, cascade

# ------------------------------------------------------------------------------
# [context.metrics] - Metrics and monitoring
# ------------------------------------------------------------------------------

[context.metrics]
enabled = true
track_latency = true
track_token_usage = true
track_cache_hits = true
export_interval_minutes = 5

# ------------------------------------------------------------------------------
# [context.bootstrap] - Initial indexing configuration
# ------------------------------------------------------------------------------

[context.bootstrap]
enabled = true
parallel_workers = 7
batch_size = 128
priority_extensions = [".kt", ".py", ".ts", ".java", ".md"]
max_initial_files = 0  # 0 = no limit
fail_fast = false
show_progress = true
progress_interval_seconds = 30

# ------------------------------------------------------------------------------
# [context.security] - Security and privacy settings
# ------------------------------------------------------------------------------

[context.security]
scrub_secrets = true
secret_patterns = [
    "password\\s*=\\s*['\"]?.*['\"]?",
    "api[_-]?key\\s*=\\s*['\"]?.*['\"]?",
    "token\\s*=\\s*['\"]?.*['\"]?",
    "secret\\s*=\\s*['\"]?.*['\"]?",
    "bearer\\s+[A-Za-z0-9\\-._~+/]+=*",
    "aws_access_key_id\\s*=\\s*[A-Z0-9]{20}",
    "private[_-]?key\\s*=\\s*['\"]?.*['\"]?"
]
encrypt_db = false

# ==============================================================================
# QUICK REFERENCE: ignore_patterns vs skip_patterns (SIDE-BY-SIDE)
# ==============================================================================
#
#                     IGNORE_PATTERNS        │        SKIP_PATTERNS
#                     ─────────────────────────────────────────────
# Config section:     [context.watcher]      │    [context.indexing]
# Processing phase:   WATCHER PHASE          │    INDEXING PHASE
# Matcher type:       Regex (glob-like)      │    Glob patterns
# When applied:       File discovery         │    After extension filter
# Purpose:            Prevent monitoring     │    Fine-grained filtering
# Scope:              Directory trees        │    Individual files
#
# EXAMPLES:
#   ".kotlin/"        → Blocks entire .kotlin/metadata directory
#   "build/"          → Blocks entire build/ directory watching
#   "*.test.ts"       → (skip_patterns) Blocks test files by name
#   "*.min.js"        → (skip_patterns) Blocks minified JS
#
# WHEN TO USE:
#   Use ignore_patterns for LARGE DIRECTORIES
#     ✓ .kotlin/, .gradle/, build/, dist/, node_modules/, .git/
#     ✓ Saves watcher resources, prevents monitoring overhead
#
#   Use skip_patterns for SPECIFIC FILES
#     ✓ *.test.ts, *.spec.js, *.min.js, *.min.css
#     ✓ Fine-grained control on what actually gets indexed
#
# PROCESSING ORDER in the system:
#   1. ignore_patterns (watcher discovery)
#   2. includePaths filter (if configured)
#   3. allowed_extensions (extension filter)
#   4. skip_patterns (glob filtering)
#   5. Binary detection
#   6. Size limits
#
# ==============================================================================

# ------------------------------------------------------------------------------
# [ignore] - File patterns to exclude from context indexing
# ------------------------------------------------------------------------------
# These patterns are used during bootstrap and watching to exclude files
# from being indexed by the context system. This replaces .contextignore.
# Note: This is a LEGACY section (mirrors context.watcher.ignore_patterns)
# Prefer using [context.watcher].ignore_patterns above.
# ------------------------------------------------------------------------------

[ignore]
patterns = [
    # Build artifacts
    "build/",
    "dist/",
    "out/",
    "target/",
    "*.class",
    "*.jar",
    "*.war",

    # Gradle
    ".gradle/",
    "gradle-app.setting",

    # Kotlin build metadata - auto-generated and pollutes search
    ".kotlin/",

    # IDE
    ".idea/",
    ".vscode/",
    "*.iml",
    "*.swp",
    "*.swo",
    "*~",

    # Node
    "node_modules/",
    "npm-debug.log",
    "yarn-error.log",

    # Python
    "__pycache__/",
    "*.pyc",
    ".venv/",
    "venv/",
    "*.egg-info/",

    # Version control
    ".git/",
    ".svn/",

    # OS
    ".DS_Store",
    ".DS_Store?",
    "._*",
    ".Spotlight-V100",
    ".Trashes",
    "ehthumbs.db",
    "Thumbs.db",

    # Test artifacts
    "/tmp/",
    "/temp/",
    "test-output/",
    ".test-results/",

    # Large files that shouldn't be indexed
    "*.log",
    "*.tmp",
    "*.bak",

    # Generated files
    "*.generated.kt",
    "*.generated.java",

    # Generated test output
    "test-output.txt"
]

# ==============================================================================
# Configuration Tips:
# ==============================================================================
#
# 1. Start with this example and adjust based on your project's needs
# 2. Use environment variables for sensitive data: apiKeyRef = "${API_KEY}"
# 3. Monitor metrics to tune query performance and token usage
# 4. Adjust chunking settings if results are too granular or too broad
# 5. Use priority_extensions to speed up initial indexing of critical files
# 6. Enable scrub_secrets in production environments
# 7. Tune provider weights based on the type of queries you perform
# 8. Increase parallel_workers on machines with more CPU cores
# 9. Use include_paths in [context.watcher] to limit indexing to specific folders:
#    - If include_paths is set, ONLY those paths will be indexed
#    - If include_paths is empty/commented, all paths except ignore_patterns are indexed
#    - Supports 3 types of paths:
#      * Relative to project root: "src/", "lib/"
#      * Absolute paths: "/home/user/projects/my-lib/", "/opt/shared-code/"
#      * Relative to parent dirs: "../sibling-project/", "../../shared/utils/"
#    - Examples:
#      * Single project: include_paths = ["src/", "lib/"]
#      * Multi-project: include_paths = ["src/", "/home/user/other-project/src/", "/opt/libs/"]
#      * Sibling access: include_paths = ["src/", "../shared-libs/", "../common/"]
# 10. Use ignore_patterns to exclude specific directories from indexing
#
# ==============================================================================
