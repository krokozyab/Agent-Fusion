/*
HTMX SSE Extension - Handles Server-Sent Events with out-of-band swaps
Properly registers with HTMX and manually connects to EventSource
*/
(function() {
  'use strict';

  // Wait for HTMX to be available
  function initSSEExtension() {
    if (!window.htmx) {
      console.debug("HTMX not ready yet, retrying in 100ms...");
      setTimeout(initSSEExtension, 100);
      return;
    }

    console.log("HTMX SSE extension loaded and registered");

    var htmx = window.htmx;

    // Register this as an HTMX extension
    // This tells HTMX that we handle the "sse" extension
    htmx.defineExtension('sse', {
      init: function(api) {
        console.log("SSE extension initialized by HTMX");
      }
    });

    // Intercept HTMX's SSE event processing BEFORE it tries to trigger events
    // This prevents the "Cannot read properties of null (reading 'dispatchEvent')" error
    document.addEventListener("htmx:sseBeforeMessage", function(evt) {
      console.log("htmx:sseBeforeMessage - lastEvent:", evt.detail ? evt.detail.lastEvent : "unknown");
      // Don't let HTMX process this event - we'll handle it ourselves
      evt.preventDefault();
      evt.stopImmediatePropagation();
    }, true); // Use capture phase to intercept early

    // Listener for SSE messages that handles out-of-band swaps
    document.addEventListener("htmx:sseMessage", function(evt) {
      try {
        if (!evt.detail) {
          console.log("No detail in SSE message");
          return;
        }

        var detail = evt.detail;
        var eventName = detail.lastEvent || detail.eventType;

        console.log("SSE Message received - lastEvent:", detail.lastEvent, "eventType:", detail.eventType, "data length:", detail.data ? detail.data.length : 0);

        if (!eventName) {
          console.log("No event name found in SSE message");
          return;
        }

        // Find target element with matching sse-swap attribute
        var target = document.querySelector('[sse-swap="' + eventName + '"]');

        if (!target) {
          var availableSwaps = [].slice.call(document.querySelectorAll("[sse-swap]")).map(function(el) {
            return el.getAttribute("sse-swap");
          });
          console.log("No swap target found for event:", eventName, "available targets:", availableSwaps);
          return;
        }

        console.log("Found swap target for event:", eventName, "element:", target.id || target.className);

        // Parse the HTML fragment from the SSE data
        var temp = document.createElement("div");
        temp.innerHTML = detail.data;
        var newContent = temp.firstElementChild || temp;

        if (!newContent) {
          console.error("Failed to parse HTML fragment");
          return;
        }

        console.log("Performing outerHTML swap");

        // Perform direct DOM replacement
        target.outerHTML = newContent.outerHTML;

        console.log("Swap completed successfully");

      } catch (e) {
        console.error("Error processing SSE message:", e, e.stack);
      }
    }, false);

    // Manually create and connect EventSource
    // Check if the page has a data-sse-url attribute (for manual connection)
    var body = document.body || document.documentElement;
    var sseUrl = body.getAttribute('data-sse-url');

    if (sseUrl) {
      console.log("Found SSE URL:", sseUrl);
      // Create the EventSource
      var eventSource = new EventSource(sseUrl, { withCredentials: true });
      console.log("Created EventSource for:", sseUrl);

      // Handle incoming events
      eventSource.addEventListener('message', function(event) {
        console.log("Raw SSE message event:", event);
      });

      // Handle all events (HTMX will recognize the event type from the 'event' field)
      eventSource.addEventListener('indexProgress', function(event) {
        var detail = {
          data: event.data,
          lastEvent: 'indexProgress'
        };
        // Fire htmx:sseBeforeMessage
        var beforeEvent = new CustomEvent('htmx:sseBeforeMessage', {
          detail: detail,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(beforeEvent);

        // Fire htmx:sseMessage (our handler will catch this)
        var messageEvent = new CustomEvent('htmx:sseMessage', {
          detail: detail,
          bubbles: true
        });
        document.dispatchEvent(messageEvent);
      });

      eventSource.addEventListener('indexSummary', function(event) {
        var detail = {
          data: event.data,
          lastEvent: 'indexSummary'
        };
        // Fire htmx:sseBeforeMessage
        var beforeEvent = new CustomEvent('htmx:sseBeforeMessage', {
          detail: detail,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(beforeEvent);

        // Fire htmx:sseMessage (our handler will catch this)
        var messageEvent = new CustomEvent('htmx:sseMessage', {
          detail: detail,
          bubbles: true
        });
        document.dispatchEvent(messageEvent);
      });

      eventSource.onerror = function(error) {
        console.error("EventSource error:", error);
        if (eventSource.readyState === EventSource.CLOSED) {
          console.log("EventSource connection closed");
        }
      };
    } else {
      console.log("No data-sse-url found on body element");
    }
  }

  // Start initialization when script loads
  initSSEExtension();
})();
