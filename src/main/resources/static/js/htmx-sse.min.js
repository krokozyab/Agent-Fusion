/*
HTMX SSE Extension - Handles out-of-band swaps using sse-swap attributes
*/
(function() {
  if (!window.htmx) {
    console.error("HTMX not loaded");
    return;
  }

  console.debug("HTMX SSE extension loaded");

  var htmx = window.htmx;

  // Listener for SSE messages that handles out-of-band swaps
  document.addEventListener("htmx:sseMessage", function(evt) {
    try {
      if (!evt.detail) return;

      var detail = evt.detail;
      var eventName = detail.lastEvent || detail.eventType;

      console.log("SSE Message received - lastEvent:", detail.lastEvent, "eventType:", detail.eventType, "data length:", detail.data ? detail.data.length : 0);

      if (!eventName) {
        console.log("No event name found in SSE message");
        return;
      }

      // Find target element with matching sse-swap attribute
      var target = document.querySelector('[sse-swap="' + eventName + '"]');

      if (!target) {
        var availableSwaps = [].slice.call(document.querySelectorAll("[sse-swap]")).map(function(el) {
          return el.getAttribute("sse-swap");
        });
        console.log("No swap target found for event:", eventName, "available targets:", availableSwaps);
        return;
      }

      console.log("Found swap target for event:", eventName, "element id:", target.id || target.className);

      // Parse the HTML fragment
      var temp = document.createElement("div");
      temp.innerHTML = detail.data;
      var newContent = temp.firstElementChild || temp;

      if (!newContent) {
        console.error("Failed to parse HTML fragment");
        return;
      }

      console.log("Performing swap for element:", target.id || target.className);

      // Use HTMX's swap method
      htmx.swap(target, "outerHTML", {
        source: newContent
      });

    } catch (e) {
      console.error("Error processing SSE message:", e);
    }
  }, false);

  // Override HTMX's event source creation
  var originalCreateEventSource = htmx.createEventSource;
  if (originalCreateEventSource) {
    htmx.createEventSource = function(url) {
      console.debug("Creating EventSource for:", url);
      return new EventSource(url, { withCredentials: true });
    };
  }

  // Error handling for null targets
  document.addEventListener("htmx:responseError", function(evt) {
    if (evt.detail && evt.detail.error) {
      var error = evt.detail.error;
      if (error && error.message && error.message.indexOf("Cannot read properties of null") >= 0) {
        console.warn("Suppressed null dispatchEvent error - target element may not exist");
        evt.preventDefault();
        return false;
      }
    }
  }, true);

})();
