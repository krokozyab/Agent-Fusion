/*
HTMX SSE Extension - Handles Server-Sent Events with out-of-band swaps
Properly registers with HTMX and handles event routing
*/
(function() {
  'use strict';

  // Wait for HTMX to be available
  function initSSEExtension() {
    if (!window.htmx) {
      console.debug("HTMX not ready yet, retrying in 100ms...");
      setTimeout(initSSEExtension, 100);
      return;
    }

    console.log("HTMX SSE extension loaded and registered");

    var htmx = window.htmx;

    // Register this as an HTMX extension
    // This tells HTMX that we handle the "sse" extension
    htmx.defineExtension('sse', {
      init: function(api) {
        console.log("SSE extension initialized by HTMX");
      }
    });

    // Intercept HTMX's SSE event processing BEFORE it tries to trigger events
    // This prevents the "Cannot read properties of null (reading 'dispatchEvent')" error
    document.addEventListener("htmx:sseBeforeMessage", function(evt) {
      console.log("htmx:sseBeforeMessage - lastEvent:", evt.detail ? evt.detail.lastEvent : "unknown");
      // Don't let HTMX process this event - we'll handle it ourselves
      evt.preventDefault();
      evt.stopImmediatePropagation();
    }, true); // Use capture phase to intercept early

    // Listener for SSE messages that handles out-of-band swaps
    document.addEventListener("htmx:sseMessage", function(evt) {
      try {
        if (!evt.detail) {
          console.log("No detail in SSE message");
          return;
        }

        var detail = evt.detail;
        var eventName = detail.lastEvent || detail.eventType;

        console.log("SSE Message received - lastEvent:", detail.lastEvent, "eventType:", detail.eventType, "data length:", detail.data ? detail.data.length : 0);

        if (!eventName) {
          console.log("No event name found in SSE message");
          return;
        }

        // Find target element with matching sse-swap attribute
        var target = document.querySelector('[sse-swap="' + eventName + '"]');

        if (!target) {
          var availableSwaps = [].slice.call(document.querySelectorAll("[sse-swap]")).map(function(el) {
            return el.getAttribute("sse-swap");
          });
          console.log("No swap target found for event:", eventName, "available targets:", availableSwaps);
          return;
        }

        console.log("Found swap target for event:", eventName, "element:", target.id || target.className);

        // Parse the HTML fragment from the SSE data
        var temp = document.createElement("div");
        temp.innerHTML = detail.data;
        var newContent = temp.firstElementChild || temp;

        if (!newContent) {
          console.error("Failed to parse HTML fragment");
          return;
        }

        console.log("Performing outerHTML swap");

        // Perform direct DOM replacement
        target.outerHTML = newContent.outerHTML;

        console.log("Swap completed successfully");

      } catch (e) {
        console.error("Error processing SSE message:", e, e.stack);
      }
    }, false);

    // Override HTMX's event source creation to ensure proper configuration
    var originalCreateEventSource = htmx.createEventSource;
    if (originalCreateEventSource) {
      htmx.createEventSource = function(url) {
        console.log("Creating EventSource for:", url);
        return new EventSource(url, { withCredentials: true });
      };
    }
  }

  // Start initialization when script loads
  initSSEExtension();
})();
